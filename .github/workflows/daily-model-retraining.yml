name: Daily Model Retraining with Commit

on:
  schedule:
    - cron: '0 21 * * *'  # 21:00 UTC = 02:00 PKT
  workflow_dispatch:

jobs:
  daily-model-retraining:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write  # Allow pushing changes

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential cmake libomp-dev python3-dev

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip wheel setuptools
          pip install -r requirements.txt
          pip install "hopsworks[python]==4.2.*"

      - name: Set timezone to Pakistan
        run: |
          sudo timedatectl set-timezone Asia/Karachi
          date

      - name: Populate training data
        env:
          OPENWEATHER_API_KEY: ${{ secrets.OPENWEATHER_API_KEY }}
          HOPSWORKS_API_KEY: ${{ secrets.HOPSWORKS_API_KEY }}
          HOPSWORKS_PROJECT: ${{ secrets.HOPSWORKS_PROJECT }}
        run: |
          python unified_aqi_hopsworks_pipeline.py hourly --max-gap-hours 720

      - name: Run model retraining
        env:
          OPENWEATHER_API_KEY: ${{ secrets.OPENWEATHER_API_KEY }}
          HOPSWORKS_API_KEY: ${{ secrets.HOPSWORKS_API_KEY }}
          HOPSWORKS_PROJECT: ${{ secrets.HOPSWORKS_PROJECT }}
        run: |
          echo "Starting daily model retraining..."
          python unified_model_training.py 2>&1 | tee training_output.txt

      - name: List produced artifacts
        run: |
          ls -R lgbm_additional || true
          ls -R xgboost_additional || true
          ls -R randomforest_additional || true

      - name: Check for new model files
        run: |
          echo "Checking for new model directories..."
          find randomforest_additional -name "*.pkl" -newer training_output.txt 2>/dev/null || echo "No new RandomForest models"
          find xgboost_additional -name "*.json" -newer training_output.txt 2>/dev/null || echo "No new XGBoost models"
          find lgbm_additional -name "*.txt" -newer training_output.txt 2>/dev/null || echo "No new LightGBM models"

      - name: Commit and push model updates
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          # Add all model files
          git add randomforest_additional/ || true
          git add xgboost_additional/ || true
          git add lgbm_additional/ || true
          git add training_output.txt || true
          
          # Check if there are changes
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Daily model retraining - $(date)"
            git push
          fi
